# ðŸŽ¨ TacticEYE Micro-Batching - Arquitectura Visual

## ðŸ“ Diagrama de Arquitectura Completa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VIDEO SOURCES LAYER                         â”‚
â”‚                     (modules/video_sources.py)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Local   â”‚  â”‚ YouTube  â”‚  â”‚   HLS   â”‚  â”‚  RTMP   â”‚  â”‚  Veo   â”‚â”‚
â”‚  â”‚  Files   â”‚  â”‚ VOD/Live â”‚  â”‚ Stream  â”‚  â”‚ Stream  â”‚  â”‚Platformâ”‚â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚         â”‚  â”‚         â”‚  â”‚        â”‚â”‚
â”‚  â”‚ OpenCV   â”‚  â”‚  yt-dlp  â”‚  â”‚ FFmpeg  â”‚  â”‚ FFmpeg  â”‚  â”‚ FFmpeg â”‚â”‚
â”‚  â”‚VideoCapt.â”‚  â”‚ + FFmpeg â”‚  â”‚         â”‚  â”‚         â”‚  â”‚ + Auth â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â”‚                                      â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                   â”‚   VideoSource       â”‚                          â”‚
â”‚                   â”‚   get_frame_gen()   â”‚                          â”‚
â”‚                   â”‚   get_metadata()    â”‚                          â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ Iterator[np.ndarray]
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BATCHING LAYER                               â”‚
â”‚                  (modules/match_analyzer.py)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ read_frame_batches(stream, batch_size=90)                â”‚  â”‚
â”‚   â”‚                                                           â”‚  â”‚
â”‚   â”‚  Batch 0        Batch 1        Batch 2        Batch N    â”‚  â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚   â”‚ â”‚Frame 0â”‚      â”‚Frame90â”‚      â”‚Frame180â”‚       ...       â”‚  â”‚
â”‚   â”‚ â”‚   â†“   â”‚      â”‚   â†“   â”‚      â”‚   â†“   â”‚                 â”‚  â”‚
â”‚   â”‚ â”‚Frame89â”‚      â”‚Frame179â”‚     â”‚Frame269â”‚                â”‚  â”‚
â”‚   â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚              â”‚              â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚              â”‚              â”‚
          â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PROCESSING LAYER                             â”‚
â”‚                 (modules/batch_processor.py)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              BatchProcessor.process_chunk()                â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  Input: MatchState + frames[90]                           â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ PIPELINE                                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  1. YOLO Detection                                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º player   (bbox, conf)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º ball     (bbox, conf)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º referee  (bbox, conf)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€â–º goalkeeper (bbox, conf)                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  2. ReID Tracker                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Assign IDs                                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Update tracks                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€â–º Extract features                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  3. Team Classifier                                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Train KMeans (first 300 frames)            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Classify players                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€â–º Voting history                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  4. Possession Tracker                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Find ball owner                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Detect possession changes                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Count passes                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€â–º Accumulate stats                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  5. Output Generation                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Detections by frame                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Player positions                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€â–º Events (passes, changes)                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€â–º Chunk stats                                â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  Output: MatchState (updated) + ChunkOutput               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                   â”‚
       â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   STATE LAYER    â”‚           â”‚    OUTPUT LAYER       â”‚
â”‚ (match_state.py) â”‚           â”‚ (batch_processor.py)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚           â”‚                       â”‚
â”‚ MatchState       â”‚           â”‚ ChunkOutput           â”‚
â”‚  â”œâ”€ match_id    â”‚           â”‚  â”œâ”€ batch_idx         â”‚
â”‚  â”œâ”€ fps         â”‚           â”‚  â”œâ”€ start_frame       â”‚
â”‚  â”œâ”€ status      â”‚           â”‚  â”œâ”€ detections_by_fr. â”‚
â”‚  â”œâ”€ total_fr.   â”‚           â”‚  â”œâ”€ player_positions  â”‚
â”‚  â”‚               â”‚           â”‚  â”œâ”€ events           â”‚
â”‚  â”œâ”€ TrackerStateâ”‚           â”‚  â””â”€ chunk_stats       â”‚
â”‚  â”‚   â”œâ”€ IDs     â”‚           â”‚                       â”‚
â”‚  â”‚   â”œâ”€ tracks  â”‚           â”‚ save_chunk_output()   â”‚
â”‚  â”‚   â””â”€ featuresâ”‚           â”‚  â”œâ”€ detections.json   â”‚
â”‚  â”‚               â”‚           â”‚  â”œâ”€ positions.json    â”‚
â”‚  â”œâ”€ TeamClassif.â”‚           â”‚  â”œâ”€ events.json       â”‚
â”‚  â”‚   â”œâ”€ map     â”‚           â”‚  â””â”€ stats.json        â”‚
â”‚  â”‚   â””â”€ colors  â”‚           â”‚                       â”‚
â”‚  â”‚               â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â””â”€ PossessionStâ”‚
â”‚      â”œâ”€ curr_tm â”‚
â”‚      â”œâ”€ frames  â”‚
â”‚      â””â”€ passes  â”‚
â”‚                  â”‚
â”‚ Storage:         â”‚
â”‚  â”œâ”€ FileSystem   â”‚
â”‚  â””â”€ Redis        â”‚
â”‚                  â”‚
â”‚ save/load()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API LAYER                                 â”‚
â”‚                    (app_streaming.py)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  REST API      â”‚      â”‚   WebSocket      â”‚                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚  â”‚                â”‚      â”‚                  â”‚                  â”‚
â”‚  â”‚ POST /upload   â”‚      â”‚ WS /ws/{id}      â”‚                  â”‚
â”‚  â”‚ POST /analyze  â”‚      â”‚                  â”‚                  â”‚
â”‚  â”‚ GET  /summary  â”‚      â”‚ Messages:        â”‚                  â”‚
â”‚  â”‚ GET  /events   â”‚      â”‚  â€¢ progress      â”‚                  â”‚
â”‚  â”‚ GET  /positionsâ”‚      â”‚  â€¢ batch_completeâ”‚                  â”‚
â”‚  â”‚ GET  /status   â”‚      â”‚  â€¢ completed     â”‚                  â”‚
â”‚  â”‚ DELETE /match  â”‚      â”‚  â€¢ error         â”‚                  â”‚
â”‚  â”‚                â”‚      â”‚                  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                  â”‚
â”‚  Threading Model:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Main Thread        Worker Thread 1     Worker Thread 2   â”‚  â”‚
â”‚  â”‚ (FastAPI)          (Match 1)           (Match 2)         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ HTTP Requests  â†’   run_match_analysis()                  â”‚  â”‚
â”‚  â”‚ WebSocket      â†   â”œâ”€ process_chunk()                    â”‚  â”‚
â”‚  â”‚                    â”œâ”€ save_state()                        â”‚  â”‚
â”‚  â”‚                    â””â”€ websocket.send()                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Flujo de Datos Detallado

### AnÃ¡lisis Completo (End-to-End)

```
Usuario                API               Analyzer            Processor           Storage
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚ 1. POST /analyze    â”‚                    â”‚                   â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚ 2. Create thread   â”‚                   â”‚                 â”‚
  â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚ 3. Response         â”‚                    â”‚ 4. open_source()  â”‚                 â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                 â”‚
  â”‚ {"success": true}   â”‚                    â”‚          â”‚        â”‚                 â”‚
  â”‚                     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚ 5. WS connect       â”‚                    â”‚ 6. Read batch 0   â”‚                 â”‚
  â”œâ”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â–ºâ”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                 â”‚
  â”‚                     â”‚                    â”‚          â”‚        â”‚                 â”‚
  â”‚                     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                 â”‚
  â”‚                     â”‚                    â”‚ frames[90]        â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚ 7. process_chunk()â”‚                 â”‚
  â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚ 8. YOLO         â”‚
  â”‚                     â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
  â”‚                     â”‚                    â”‚                   â”‚        â”‚        â”‚
  â”‚                     â”‚                    â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
  â”‚                     â”‚                    â”‚                   â”‚ detections      â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚ 9. ReID Track   â”‚
  â”‚                     â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
  â”‚                     â”‚                    â”‚                   â”‚        â”‚        â”‚
  â”‚                     â”‚                    â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
  â”‚                     â”‚                    â”‚                   â”‚ tracked_objs    â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚ 10. TeamClassifyâ”‚
  â”‚                     â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
  â”‚                     â”‚                    â”‚                   â”‚        â”‚        â”‚
  â”‚                     â”‚                    â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
  â”‚                     â”‚                    â”‚                   â”‚ teams           â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚ 11. Possession  â”‚
  â”‚                     â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
  â”‚                     â”‚                    â”‚                   â”‚        â”‚        â”‚
  â”‚                     â”‚                    â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
  â”‚                     â”‚                    â”‚                   â”‚ stats, events   â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚ 12. state, output â”‚                 â”‚
  â”‚                     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚ 13. save_state()  â”‚                 â”‚
  â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚ 14. save_output() â”‚                 â”‚
  â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚ 15. callback       â”‚                   â”‚                 â”‚
  â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚ 16. WS progress     â”‚                    â”‚                   â”‚                 â”‚
  â”‚â—„â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”¤                    â”‚                   â”‚                 â”‚
  â”‚ {"progress": 10%}   â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚ 17. Read batch 1  â”‚                 â”‚
  â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                 â”‚
  â”‚                     â”‚                    â”‚          â”‚        â”‚                 â”‚
  â”‚                     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                 â”‚
  â”‚                     â”‚                    â”‚ ... (loop) ...    â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚ N. End of stream  â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚ N+1. callback      â”‚                   â”‚                 â”‚
  â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚ N+2. WS completed   â”‚                    â”‚                   â”‚                 â”‚
  â”‚â—„â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”¤                    â”‚                   â”‚                 â”‚
  â”‚ {"type":"completed"}â”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚ N+3. GET /summary   â”‚                    â”‚                   â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                   â”‚                 â”‚
  â”‚                     â”‚ N+4. load_state()  â”‚                   â”‚                 â”‚
  â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚                     â”‚                    â”‚                   â”‚                 â”‚
  â”‚ N+5. Response       â”‚                    â”‚                   â”‚                 â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚                 â”‚
  â”‚ {possession: ...}   â”‚                    â”‚                   â”‚                 â”‚
```

---

## ðŸ“¦ Estructura de Datos

### MatchState (Persistido)

```json
{
  "match_id": "match_001",
  "source_type": "uploaded_file",
  "fps": 30.0,
  "status": "running",
  "total_frames_processed": 450,
  "last_batch_idx": 4,
  "last_update": "2025-01-23T10:30:45",
  
  "tracker_state": {
    "active_tracks": {
      "1": {"id": 1, "age": 120, "...": "..."},
      "5": {"id": 5, "age": 85, "...": "..."}
    },
    "next_id": 25,
    "lost_tracks": {},
    "last_frame_idx": 449
  },
  
  "team_classifier_state": {
    "player_team_map": {
      "1": 0, "2": 0, "5": 1, "7": 1
    },
    "vote_history": {
      "1": [0, 0, 0, 0]
    },
    "team_colors": {
      "0": [45.2, 12.1, -8.3],
      "1": [38.5, -5.2, 15.7]
    },
    "is_trained": true
  },
  
  "possession_state": {
    "current_team": 0,
    "current_player": 5,
    "frames_by_team": {
      "0": 260,
      "1": 190,
      "-1": 0
    },
    "passes_by_team": {
      "0": 8,
      "1": 5
    },
    "possession_changes": [
      {"frame": 120, "from": 0, "to": 1},
      {"frame": 285, "from": 1, "to": 0}
    ]
  },
  
  "cached_summary": {
    "possession": {
      "percent_by_team": {"0": 57.8, "1": 42.2}
    }
  }
}
```

### ChunkOutput (Por Batch)

```json
{
  "batch_idx": 5,
  "start_frame": 450,
  "end_frame": 539,
  
  "detections_by_frame": {
    "450": {
      "objects": [
        {
          "track_id": 5,
          "class_name": "player",
          "team_id": 0,
          "bbox": [450, 320, 520, 480],
          "conf": 0.92
        },
        {
          "track_id": -1,
          "class_name": "ball",
          "bbox": [485, 380, 505, 400],
          "conf": 0.85
        }
      ],
      "ball_owner": 5,
      "possession_team": 0
    }
  },
  
  "player_positions": [
    {
      "frame": 450,
      "timestamp": 15.0,
      "player_id": 5,
      "team_id": 0,
      "bbox": [450, 320, 520, 480],
      "position": [485, 400]
    }
  ],
  
  "events": [
    {
      "type": "pass",
      "frame": 465,
      "timestamp": 15.5,
      "team": 0,
      "from_player": 5,
      "to_player": 7
    }
  ],
  
  "chunk_stats": {
    "frames_processed": 90,
    "detections_count": 1250,
    "events_count": 2,
    "possession_team": 0
  },
  
  "processing_time_ms": 1850.5
}
```

---

## âš™ï¸ ConfiguraciÃ³n de Batching

### Tabla de DecisiÃ³n

| Caso de Uso | FPS | Segundos/Batch | Frames/Batch | Latencia | Factor RT |
|-------------|-----|----------------|--------------|----------|-----------|
| **Post-AnÃ¡lisis** | 30 | 5.0 | 150 | N/A | 2-3x |
| **Live Normal** | 30 | 3.0 | 90 | ~3s | 1.5x |
| **Live Ultra-Low** | 30 | 2.0 | 60 | ~2s | 1.2x |
| **Slow Motion** | 60 | 2.0 | 120 | ~2s | 1.0x |

### Ejemplo de ConfiguraciÃ³n

```python
# VOD - Priorizar velocidad
config_vod = AnalysisConfig(
    batch_size_seconds=5.0,
    device="cuda",
    conf_threshold=0.3
)

# Live - Balance latencia/calidad
config_live = AnalysisConfig(
    batch_size_seconds=3.0,
    device="cuda",
    conf_threshold=0.35
)

# Live Ultra-Low - MÃ­nima latencia
config_ultra = AnalysisConfig(
    batch_size_seconds=2.0,
    device="cuda",
    conf_threshold=0.4,  # Menos detecciones = mÃ¡s rÃ¡pido
    imgsz=640  # Menor resoluciÃ³n
)
```

---

## ðŸŽ¯ Puntos Clave de la Arquitectura

### âœ… SeparaciÃ³n de Responsabilidades

```
video_sources.py    â†’ AbstracciÃ³n de entrada
match_state.py      â†’ Persistencia y recuperaciÃ³n
batch_processor.py  â†’ LÃ³gica de anÃ¡lisis
match_analyzer.py   â†’ OrquestaciÃ³n
app_streaming.py    â†’ ExposiciÃ³n API
```

### âœ… Contratos Claros

```python
# Todas las fuentes cumplen:
class VideoSource:
    def get_frame_generator() -> Iterator[np.ndarray]
    def get_metadata() -> VideoMetadata

# Todo el pipeline usa:
def process_chunk(state, frames, ...) -> (state, output)

# Todos los storage cumplen:
class StateStorage:
    def save(match_id, state)
    def load(match_id) -> MatchState
```

### âœ… Extensibilidad

```python
# AÃ±adir nueva fuente:
class TwitchSource(FFmpegStreamSource):
    def __init__(self, twitch_url): ...

# AÃ±adir nuevo storage:
class PostgresStorage(StateStorage):
    def save(self, match_id, state): ...

# AÃ±adir callback:
config.on_custom_event = lambda data: notify_slack(data)
```

---

**Desarrollado por TacticEYE Team**  
*Arquitectura Modular y Escalable*
